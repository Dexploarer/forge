# Forge Backend

**Production-ready API backend built with Bun, Fastify, and Drizzle ORM**

---

## ğŸš€ Quick Start

### Prerequisites
- Bun >= 1.0.0
- PostgreSQL >= 14
- FFmpeg (optional, for audio processing features)

### FFmpeg Installation (Optional)

FFmpeg is required for advanced audio processing features like normalization, silence trimming, format conversion, and metadata extraction. The backend will gracefully degrade to estimation mode if FFmpeg is not available.

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install ffmpeg
```

**macOS (Homebrew):**
```bash
brew install ffmpeg
```

**Windows (Chocolatey):**
```bash
choco install ffmpeg
```

**Verification:**
```bash
ffmpeg -version
ffprobe -version
```

**Custom FFmpeg Paths (Optional):**
If ffmpeg/ffprobe are not in your system PATH, you can specify custom paths in `.env`:
```env
FFMPEG_PATH=/path/to/ffmpeg
FFPROBE_PATH=/path/to/ffprobe
```

### Installation

```bash
# Install dependencies
bun install

# Copy environment variables
cp .env.example .env

# Edit .env with your values
# - DATABASE_URL
# - PRIVY_APP_ID
# - PRIVY_APP_SECRET

# Generate database migration
bun run db:generate

# Run migration
bun run db:migrate

# Start development server
bun run dev
```

Server will be running at `http://localhost:3000`

---

## ğŸ“‹ What's Been Built

### âœ… Core Infrastructure
- [x] **Package configuration** - Minimal dependencies, production-focused
- [x] **TypeScript setup** - Strict mode, path aliases
- [x] **Environment validation** - Zod-powered type-safe config
- [x] **Drizzle ORM** - PostgreSQL with connection pooling
- [x] **Clean database schema** - Users + Assets only (simple!)

### âœ… Database Schema

**PostgreSQL Enums (Type-safe!):**
- `user_role`: admin, member, guest
- `asset_status`: draft, processing, published, failed
- `asset_type`: model, texture, audio
- `visibility_type`: private, public

**Tables:**
1. **users** - Authentication & profiles
   - Privy integration (`privy_user_id`)
   - Farcaster support (`farcaster_fid`, `farcaster_username`)
   - Role-based access control
   - Proper indexes

2. **assets** - 3D models, audio, textures
   - Owner relationship
   - File metadata (URL, size, MIME type)
   - Generation params (if AI-generated)
   - Composite indexes for performance

### ğŸ“ Project Structure

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ env.ts              â† âœ… Environment validation
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ schema/
â”‚   â”‚   â”‚   â”œâ”€â”€ enums.ts        â† âœ… PostgreSQL enums
â”‚   â”‚   â”‚   â”œâ”€â”€ users.ts        â† âœ… Users table
â”‚   â”‚   â”‚   â”œâ”€â”€ assets.ts       â† âœ… Assets table
â”‚   â”‚   â”‚   â””â”€â”€ index.ts        â† âœ… Schema export
â”‚   â”‚   â”œâ”€â”€ db.ts               â† âœ… Database connection
â”‚   â”‚   â”œâ”€â”€ migrate.ts          â† âœ… Migration runner
â”‚   â”‚   â””â”€â”€ migrations/         â† (Generated by Drizzle)
â”‚   â”œâ”€â”€ plugins/                â† TODO: Fastify plugins
â”‚   â”œâ”€â”€ routes/                 â† TODO: API routes
â”‚   â”œâ”€â”€ services/               â† TODO: Business logic
â”‚   â”œâ”€â”€ utils/                  â† TODO: Utilities
â”‚   â”œâ”€â”€ types/                  â† TODO: TypeScript types
â”‚   â”œâ”€â”€ server.ts               â† TODO: Fastify server
â”‚   â””â”€â”€ index.ts                â† TODO: Application entry
â”œâ”€â”€ tests/                      â† TODO: Test files
â”œâ”€â”€ drizzle.config.ts           â† âœ… Drizzle configuration
â”œâ”€â”€ package.json                â† âœ… Dependencies
â”œâ”€â”€ tsconfig.json               â† âœ… TypeScript config
â”œâ”€â”€ .env.example                â† âœ… Environment template
â””â”€â”€ README.md                   â† You are here
```

---

## ğŸ› ï¸ Available Scripts

```bash
# Development
bun run dev              # Start with hot reload

# Production
bun run build            # Build for production
bun run start            # Start production server

# Database
bun run db:generate      # Generate migration from schema
bun run db:migrate       # Run migrations
bun run db:push          # Push schema directly (dev only!)
bun run db:studio        # Open Drizzle Studio GUI

# Quality
bun run typecheck        # TypeScript type checking
bun run test             # Run tests
bun run lint             # ESLint
```

---

## ğŸ“ Next Steps

### Phase 1: Authentication (In Progress)
- [ ] Create Privy JWT authentication plugin
- [ ] Implement auth middleware
- [ ] Add user creation on first login
- [ ] Build `/api/auth/me` endpoint

### Phase 2: Core Routes
- [ ] User routes (GET, PATCH)
- [ ] Asset CRUD routes
- [ ] File upload handling

### Phase 3: Documentation & Testing
- [ ] Swagger/OpenAPI docs
- [ ] API tests
- [ ] Error handling

### Phase 4: Deployment
- [ ] Railway configuration
- [ ] Production deployment
- [ ] Monitoring setup

---

## ğŸ¯ Design Principles

This backend follows these principles:

1. **KISS** - Keep It Simple, Stupid
   - No unnecessary abstractions
   - One clear way to do things
   - Code should be obvious

2. **Production-First**
   - Every line deployment-ready
   - Comprehensive error handling
   - Proper logging
   - Security by default

3. **Type Safety**
   - PostgreSQL enums
   - Zod validation
   - TypeScript strict mode
   - No `any` types

4. **Performance**
   - Connection pooling
   - Composite indexes
   - Efficient queries
   - Minimal dependencies

---

## ğŸ”’ Security

- âœ… **Privy JWT authentication** - Industry-standard Web3 auth
- âœ… **Environment variable validation** - Fail fast on misconfiguration
- âœ… **SQL injection protection** - Drizzle ORM parameterized queries
- âœ… **Type safety** - PostgreSQL enums prevent invalid data
- ğŸ”„ **CORS** - TODO: Configure allowed origins
- ğŸ”„ **Rate limiting** - TODO: Add rate limiting plugin
- ğŸ”„ **Input validation** - TODO: Zod schemas on all routes

---

## ğŸ“Š Database Schema Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚         â”‚    assets    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ owner_id (FK)â”‚
â”‚ privy_id    â”‚         â”‚ name         â”‚
â”‚ email       â”‚         â”‚ type         â”‚
â”‚ wallet_addr â”‚         â”‚ status       â”‚
â”‚ farcaster_  â”‚         â”‚ visibility   â”‚
â”‚   fid       â”‚         â”‚ file_url     â”‚
â”‚ role        â”‚         â”‚ metadata     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¤ Contributing

When adding new features:

1. **Start with schema** - Update Drizzle schema first
2. **Generate migration** - `bun run db:generate`
3. **Test migration** - `bun run db:migrate` on local DB
4. **Build routes** - Add API endpoints
5. **Add validation** - Zod schemas for all inputs
6. **Write tests** - Comprehensive coverage
7. **Update docs** - Keep README current

---

## ğŸ“š Documentation

- [Architecture Overview](../ARCHITECTURE.md)
- [Drizzle ORM Docs](https://orm.drizzle.team)
- [Fastify Docs](https://fastify.dev)
- [Privy Docs](https://docs.privy.io)

---

## ğŸµ Audio Processing Service

The backend includes a production-ready audio processing service powered by FFmpeg with graceful degradation.

### Features

**Normalize Volume:**
```typescript
import { audioProcessorService } from './services/audio-processor.service'

// Normalize audio to -16 dB (broadcast standard)
const normalized = await audioProcessorService.normalizeVolume(audioBuffer, -16)
```

**Trim Silence:**
```typescript
// Remove silence from beginning and end (-40 dB threshold)
const trimmed = await audioProcessorService.trimSilence(audioBuffer, -40)
```

**Convert Format:**
```typescript
// Convert to WAV format
const converted = await audioProcessorService.convertFormat(audioBuffer, 'wav')
// Supported: mp3, wav, ogg, flac, m4a, aac
```

**Extract Metadata:**
```typescript
// Get accurate audio metadata
const metadata = await audioProcessorService.extractMetadata(audioBuffer)
// Returns: { duration, format, sampleRate, channels, bitrate, codec }
```

### Graceful Degradation

If FFmpeg is not installed, the service will:
- Return the original buffer for processing methods
- Use file size estimation for metadata extraction
- Log warnings about limited functionality
- Never throw errors due to missing FFmpeg

### Check Availability

```typescript
// Check if FFmpeg/FFprobe are available
const availability = await audioProcessorService.isAvailable()
console.log(availability) // { ffmpeg: true, ffprobe: true }
```

---

## âš¡ Performance Notes

**Database Connection Pool:**
- Development: 10 connections
- Production: 20 connections
- Idle timeout: 30s
- Connection max lifetime: 30min

**Composite Indexes:**
- `assets(owner_id, status)` - User's assets by status
- `assets(owner_id, type)` - User's assets by type
- `assets(status, created_at)` - Recent assets by status

---

## ğŸ¤– AI Features

The backend includes comprehensive AI integration with OpenAI, Anthropic, Meshy, and ElevenLabs through multiple service layers.

### AI Services (`/api/ai/*`)

**Usage Tracking:**
```typescript
// Get AI service usage statistics
GET /api/ai/usage
GET /api/ai/usage?service=openai
GET /api/ai/usage?startDate=2024-01-01&endDate=2024-12-31

// Get cost breakdown by service
GET /api/ai/usage/cost

// Get recent AI service calls
GET /api/ai/calls/recent?limit=20&service=openai
```

**Text Generation:**
```typescript
// Chat completion with OpenAI
POST /api/ai/chat
{
  "messages": [
    { "role": "user", "content": "Tell me about game design" }
  ],
  "model": "gpt-4-turbo",
  "temperature": 0.7,
  "maxTokens": 1000
}

// Generate with Claude (Anthropic)
// Uses Vercel AI SDK v5 for unified access
```

**Embeddings & Search:**
```typescript
// Generate text embeddings
POST /api/ai/embed
{
  "text": "Game asset description",
  "model": "text-embedding-3-small"
}

// Semantic search across game content
POST /api/ai/search
{
  "query": "medieval weapons",
  "projectId": "uuid",
  "threshold": 0.7,
  "limit": 10
}

// Semantic similarity search
POST /api/ai/semantic/search
{
  "query": "sword",
  "texts": ["blade", "shield", "bow"],
  "topK": 5
}
```

**Vision & Audio:**
```typescript
// Analyze single image with GPT-4 Vision
POST /api/ai/vision/analyze
{
  "imageUrl": "https://example.com/image.jpg",
  "prompt": "Describe this game asset",
  "detail": "high"
}

// Analyze multiple images
POST /api/ai/vision/analyze-multiple
{
  "images": [
    { "url": "https://example.com/img1.jpg", "detail": "high" },
    { "url": "https://example.com/img2.jpg", "detail": "low" }
  ],
  "prompt": "Compare these assets"
}

// Transcribe audio with Whisper
POST /api/ai/audio/transcribe
{
  "audioUrl": "https://example.com/audio.mp3",
  "language": "en"
}

// Translate audio to English
POST /api/ai/audio/translate
{
  "audioUrl": "https://example.com/audio.mp3"
}
```

**Image & 3D Generation:**
```typescript
// Generate image with DALL-E
POST /api/ai/generate-image
{
  "prompt": "A medieval sword in low-poly style",
  "size": "1024x1024",
  "quality": "hd",
  "style": "vivid"
}

// Generate 3D model with Meshy
POST /api/ai/generate-model
{
  "prompt": "A low-poly tree for a game",
  "artStyle": "low-poly",
  "topology": "quad",
  "targetPolycount": 30000
}
```

### AI Gateway (`/api/ai-gateway/*`)

Unified interface for AI model management with Vercel AI SDK v5 integration.

**Gateway Status & Models:**
```typescript
// Check AI Gateway availability
GET /api/ai-gateway/status
// Returns: { enabled: boolean, provider: string, message: string }

// List available models
GET /api/ai-gateway/models
// Returns: { count: number, models: [...] }

// Get model pricing
GET /api/ai-gateway/models/:modelId/pricing
// Returns: { modelId, pricing: {...} }

// List supported providers
GET /api/ai-gateway/providers
// Returns: { count: number, providers: [...] }
```

**Credits & Cost Estimation:**
```typescript
// Get credit balance
GET /api/ai-gateway/credits
// Returns: { balance: number, totalUsed: number, unit: "USD" }

// Estimate cost before making a request
POST /api/ai-gateway/estimate
{
  "model": "openai/gpt-4o",
  "inputTokens": 1000,
  "outputTokens": 500
}
// Returns: {
//   model: "openai/gpt-4o",
//   estimate: {
//     inputTokens: 1000,
//     outputTokens: 500,
//     costs: { input: 0.01, output: 0.03, total: 0.04 },
//     unit: "USD"
//   }
// }
```

### AI Context Preferences (`/api/ai-context/*`)

Manage user preferences for AI context building with preview manifests.

**Preferences Management:**
```typescript
// Get user's AI context preferences
GET /api/ai-context/preferences
// Returns: {
//   preferences: {
//     useOwnPreview: boolean,
//     useCdnContent: boolean,
//     useTeamPreview: boolean,
//     useAllSubmissions: boolean,
//     maxContextItems: number,
//     preferRecent: boolean
//   }
// }

// Update preferences
PUT /api/ai-context/preferences
{
  "useOwnPreview": true,
  "maxContextItems": 100,
  "preferRecent": true
}
```

**Context Building:**
```typescript
// Build combined manifest context
POST /api/ai-context/build
{
  "types": ["npc", "quest"] // Optional filter
}
// Returns: {
//   context: [
//     { type: "npc", data: [...] },
//     { type: "quest", data: [...] }
//   ],
//   totalItems: number,
//   sources: {
//     ownPreview: number,
//     cdnContent: number,
//     teamPreview: number,
//     allSubmissions: number
//   },
//   metadata: {
//     preferRecent: boolean,
//     maxContextItems: number
//   }
// }
```

### Multi-Agent System (`/api/multi-agent/*`)

Collaborative AI content generation with multiple agents.

**NPC Collaboration:**
```typescript
// Multi-NPC collaborative content generation
POST /api/multi-agent/generate-npc-collaboration
{
  "npcPersonas": [
    {
      "name": "Guard Captain",
      "personality": "stern, dutiful",
      "archetype": "warrior",
      "goals": ["Protect the city"],
      "specialties": ["Combat", "Leadership"]
    },
    {
      "name": "Merchant",
      "personality": "friendly, shrewd",
      "archetype": "trader",
      "goals": ["Make profit"],
      "specialties": ["Negotiation"]
    }
  ],
  "collaborationType": "dialogue", // dialogue|quest|lore|relationship|freeform
  "context": {
    "scenario": "The merchant wants to enter the city",
    "location": "City gates"
  },
  "rounds": 5,
  "enableCrossValidation": true
}
// Returns: {
//   sessionId: string,
//   collaborationType: string,
//   npcCount: number,
//   rounds: number,
//   conversation: [...],
//   emergentContent: {...},
//   validation: {...},
//   stats: {...}
// }
```

**Playtester Personas:**
```typescript
// Get predefined playtester personas
GET /api/multi-agent/playtester-personas
// Returns: {
//   availablePersonas: ["completionist", "casual", "breaker", ...],
//   personas: {
//     completionist: {
//       name: "Completionist",
//       personality: "Thorough, methodical...",
//       expectations: ["Find all content", ...]
//     },
//     ...
//   },
//   defaultSwarm: ["completionist", "casual", "breaker", "speedrunner", "explorer"]
// }

// Generate playtester swarm (Service migration pending)
POST /api/multi-agent/generate-playtester-swarm
// Currently returns 503 - Service Unavailable
```

### Environment Variables

Add these to your `.env` file for full AI functionality:

```env
# OpenAI
OPENAI_API_KEY=sk-...

# Anthropic (Claude)
ANTHROPIC_API_KEY=sk-ant-...

# Meshy (3D Generation)
MESHY_API_KEY=...

# ElevenLabs (Voice)
ELEVENLABS_API_KEY=...

# Vercel AI Gateway (Optional - for unified access)
AI_GATEWAY_API_KEY=...
VERCEL_ENV=production
```

### Features

- âœ… **Usage Tracking** - Track all AI service calls with cost and token usage
- âœ… **Cost Optimization** - Real-time cost estimation before API calls
- âœ… **Rate Limiting** - Per-user rate limits on AI endpoints
- âœ… **Input Validation** - Comprehensive Zod schemas on all inputs
- âœ… **Error Handling** - Graceful degradation when services unavailable
- âœ… **Vercel AI SDK v5** - Unified AI service integration
- âœ… **Multi-Agent Orchestration** - Collaborative AI content generation
- âœ… **Context Management** - Smart AI context building from manifests
- âœ… **Model Configuration** - Per-task model selection and configuration

---

**Built with â¤ï¸ for production deployments**
